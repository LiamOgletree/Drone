/*
 * taskStateMachine.c
 *
 *  Created on: Oct 3, 2024
 *      Author: liamt
 */

#include "taskStateMachine.h"
#include "sensor.h"
#include "kalmanfilter.h"

/******************************/
/*       CORE FUNCTIONS       */
/******************************/

void StartStateMachine(void *argument)
{
    // Initialize the Kalman Filter based on the drone system.
    KALMAN_FILTER filter = {
        .x =  {{0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}, {0}},
        .F =  {{1, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 1, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 1, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 1, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 1, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 1, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 1, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 1, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 1}},
        .P =  {{0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0}},
        .Q =  {{0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0}},
        .Ha = {{0, 0, 0.00980665, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0.00980665, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 0, 0, 0.00980665}},
        .Hp = {{0, 0, 0, 1, 0, 0, 0, 0, 0}},
        .Hg = {{1, 0, 0, 0, 0, 0, 0, 0, 0},
               {0, 0, 0, 1, 0, 0, 0, 0, 0},
               {0, 0, 0, 0, 0, 0, 1, 0, 0}},
        .Ra = {{0.014709975, 0, 0},
               {0, 0.014709975, 0},
               {0, 0, 0.014709975}},
        .Rp = {{1}},
        .Rg = {{1, 0, 0},
               {0, 1, 0},
               {0, 0, 1}}};

    // Perform basic filter setup.
    filter_ctor(&filter);

    while(1) {
        osDelay(100);
    }
}
